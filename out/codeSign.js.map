{
  "version": 3,
  "file": "codeSign.js",
  "sourceRoot": "",
  "sources": [
    "../src/codeSign.ts"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "import { exec } from \"./util\"\nimport { deleteFile, outputFile } from \"fs-extra-p\"\nimport { download } from \"./httpRequest\"\nimport { tmpdir } from \"os\"\nimport * as path from \"path\"\nimport { executeFinally, all } from \"./promise\"\nimport { Promise as BluebirdPromise } from \"bluebird\"\nimport { randomBytes } from \"crypto\"\n\n//noinspection JSUnusedLocalSymbols\nconst __awaiter = require(\"./awaiter\")\n\nexport interface CodeSigningInfo {\n  name: string\n  keychainName?: string | null\n\n  installerName?: string | null\n}\n\nfunction randomString(): string {\n  return randomBytes(8).toString(\"hex\")\n}\n\nexport function generateKeychainName(): string {\n  return \"csc-\" + randomString() + \".keychain\"\n}\n\nfunction downloadUrlOrBase64(urlOrBase64: string, destination: string): BluebirdPromise<any> {\n  if (urlOrBase64.startsWith(\"https://\")) {\n    return download(urlOrBase64, destination)\n  }\n  else {\n    return outputFile(destination, new Buffer(urlOrBase64, \"base64\"))\n  }\n}\n\nexport function createKeychain(keychainName: string, cscLink: string, cscKeyPassword: string, cscILink?: string | null, cscIKeyPassword?: string | null, csaLink?: string | null): Promise<CodeSigningInfo> {\n  const certLinks = csaLink == null ? [] : [csaLink]\n  certLinks.push(cscLink)\n  if (cscILink != null) {\n    certLinks.push(cscILink)\n  }\n\n  const certPaths = certLinks.map(it => path.join(tmpdir(), randomString() + (it.endsWith(\".cer\") ? \".cer\" : \".p12\")))\n  const keychainPassword = randomString()\n  return executeFinally(BluebirdPromise.all([\n      BluebirdPromise.map(certPaths, (p, i) => downloadUrlOrBase64(certLinks[i], p)),\n      BluebirdPromise.mapSeries([\n        [\"create-keychain\", \"-p\", keychainPassword, keychainName],\n        [\"unlock-keychain\", \"-p\", keychainPassword, keychainName],\n        [\"set-keychain-settings\", \"-t\", \"3600\", \"-u\", keychainName]\n      ], it => exec(\"security\", it))\n    ])\n    .then(() => importCerts(keychainName, certPaths, [cscKeyPassword, cscIKeyPassword].filter(it => it != null), csaLink == null)),\n    errorOccurred => {\n      const tasks = certPaths.map(it => deleteFile(it, true))\n      if (errorOccurred) {\n        tasks.push(deleteKeychain(keychainName))\n      }\n      return all(tasks)\n    })\n}\n\nasync function importCerts(keychainName: string, paths: Array<string>, keyPasswords: Array<string | null | undefined>, importBundledCerts: boolean): Promise<CodeSigningInfo> {\n  const certFiles = paths.slice(0, -keyPasswords.length)\n  if (importBundledCerts) {\n    const bundledCertsPath = path.join(__dirname, \"..\", \"certs\")\n    certFiles.push(\n      path.join(bundledCertsPath, \"AppleWWDRCA.cer\"),\n      path.join(bundledCertsPath, \"bundle.crt\")\n    )\n  }\n\n  for (let file of certFiles) {\n    await exec(\"security\", [\"import\", file, \"-k\", keychainName, \"-T\", \"/usr/bin/codesign\"])\n  }\n\n  const namePromises: Array<Promise<string>> = []\n  for (let i = paths.length - keyPasswords.length, j = 0; i < paths.length; i++, j++) {\n    const password = keyPasswords[j]!\n    const certPath = paths[i]\n    await exec(\"security\", [\"import\", certPath, \"-k\", keychainName, \"-T\", \"/usr/bin/codesign\", \"-T\", \"/usr/bin/productbuild\", \"-P\", password])\n\n    namePromises.push(extractCommonName(password, certPath))\n  }\n\n  const names = await BluebirdPromise.all(namePromises)\n  return {\n    name: names[0],\n    installerName: names.length > 1 ? names[1] : null,\n    keychainName: keychainName,\n  }\n}\n\nfunction extractCommonName(password: string, certPath: string): BluebirdPromise<string> {\n  return exec(\"openssl\", [\"pkcs12\", \"-nokeys\", \"-nodes\", \"-passin\", \"pass:\" + password, \"-nomacver\", \"-clcerts\", \"-in\", certPath])\n    .then(result => {\n      const match = <Array<string | null> | null>(result[0].toString().match(/^subject.*\\/CN=([^\\/\\n]+)/m))\n      if (match == null || match[1] == null) {\n        throw new Error(\"Cannot extract common name from p12\")\n      }\n      else {\n        return match[1]!\n      }\n    })\n}\n\nexport function sign(path: string, options: CodeSigningInfo): BluebirdPromise<any> {\n  const args = [\"--deep\", \"--force\", \"--sign\", options.name, path]\n  if (options.keychainName != null) {\n    args.push(\"--keychain\", options.keychainName)\n  }\n  return exec(\"codesign\", args)\n}\n\nexport function deleteKeychain(keychainName: string, ignoreNotFound: boolean = true): BluebirdPromise<any> {\n  const result = exec(\"security\", [\"delete-keychain\", keychainName])\n  if (ignoreNotFound) {\n    return result.catch(error => {\n      if (!error.message.includes(\"The specified keychain could not be found.\")) {\n        throw error\n      }\n    })\n  }\n  else {\n    return result\n  }\n}\n\nexport function downloadCertificate(cscLink: string): Promise<string> {\n  const certPath = path.join(tmpdir(), randomString() + \".p12\")\n  return downloadUrlOrBase64(cscLink, certPath)\n    .thenReturn(certPath)\n}\n"
  ]
}
